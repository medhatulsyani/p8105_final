---
title: "Maps_For_Shiny"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---
This page won't be included in the website and was an initial attempt at a shiny 
```{r, include = FALSE} 
library(tidyverse)
library(stringr)
library(leaflet)
library(tigris)
options(tigris_use_cache = TRUE)
library(sf)
library(RColorBrewer)
library(flexdashboard)
library(shiny)

#import data
traffic_shiny = read.csv("clean_data/traffic_clean.csv") %>% 
  group_by(segment_id, yr) %>% 
  summarize(total_volume = sum(vol, na.rm = TRUE), avg_volume = mean(vol, na.rm = TRUE), .groups = "drop") 

#summary volume for intersections

traffic_points = read.csv("./clean_data/traffic_clean.csv") %>%
  st_as_sf(wkt = "wkt_geom", crs = 2263) %>%  #convert wkt_geom to longitude and latitude system for mapping
  st_transform(4326)

traffic = traffic_points %>%
  left_join(traffic_shiny, by = "segment_id", relationship = "many-to-many") %>% 
  select(-request_id, -m, -d, -hh, -mm, -vol) %>% 
  group_by(segment_id) %>% #use instead of distinct becasue distinct takes too long
  slice(1) %>%
  ungroup() %>% 
  rename("borough" = boro) %>% 
  mutate(
    lon = st_coordinates(wkt_geom)[,1],
    lat = st_coordinates(wkt_geom)[,2]
  )

aed_inventory_df = read.csv("clean_data/aed_clean.csv")

aed_clean = aed_inventory_df %>%
  mutate(location = str_replace(location_point,"^POINT\\s*", "")
         )
```

Column {.sidebar}
-----------------------------------------------------------------------

### Select Map Details

```{r}
boroughs = traffic %>% distinct(borough) %>%  pull()

selectInput(
  "borough_choice", 
  label = h3("Select borough"),
  choices = boroughs, selected = "Manhattan")

max_vol = traffic %>% distinct(avg_volume) %>% max()
min_vol = traffic %>% distinct(avg_volume) %>% min()
  
# sliderInput widget for traffic volume
sliderInput(
  "volume_range", 
  label = h3("Choose traffic volume range"), 
  min = min_vol, max = max_vol, value = c(100, 400))

#year widget radiobutton
years = traffic %>%  distinct(yr.y) %>% pull()

radioButtons(
  "year_choice", 
  label = h3("Select year(s)"),
  choices = years, selected = "2019")
```


Column {data-width=650}
-----------------------------------------------------------------------

### Interactive AED and Traffic Map

```{r}
icons = awesomeIcons(
  icon = 'heart',
  library = 'fa',
  markerColor = "pink",
  iconColor = 'white'
)  

renderLeaflet({
  addProviderTiles(providers$CartoDB.Positron) %>%
  addAwesomeMarkers(
    data = aed_clean,
    lng = ~longitude,
    lat = ~latitude,
    icon = icons,
    popup = ~paste0(
      "<b>Location Name: </b>", entity_name, "<br>",
      "<b>Number of AEDs: </b>", aed_num_aeds, "<br>",
      "<b>Location: </b>", location, "<br>",
      "<b>Borough: </b>", borough, "<br>",
      "<b>Trained Personnel: </b>", aed_num_person_trained),
    clusterOptions = markerClusterOptions(),
    group = "AED_locations") %>% 
  addCircleMarkers(
    data = traffic,
    lng = ~lon,
    lat = ~lat,
    radius = 3,
    color = ~colorNumeric("RdYlBu", avg_volume)(avg_volume),  #average volume scale by color
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Street: ", street, "</b><br>",
      "Total Volume: ", total_volume, "<br>",
      "Average Volume: ", avg_volume, "<br>"), 
    group = "traffic_volume") %>%
  addLayersControl(
    overlayGroups = c("AED_locations" , "traffic_volume"),
    options = layersControlOptions(collapsed = FALSE))
  })
```

  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addAwesomeMarkers(
    data = aed_clean,
    lng = ~longitude,
    lat = ~latitude,
    icon = icons,
    popup = ~paste0(
      "<b>Location Name: </b>", entity_name, "<br>",
      "<b>Number of AEDs: </b>", aed_num_aeds, "<br>",
      "<b>Location: </b>", location, "<br>",
      "<b>Borough: </b>", borough, "<br>",
      "<b>Trained Personnel: </b>", aed_num_person_trained),
    clusterOptions = markerClusterOptions(),
    group = "AED_locations") %>% 
  addCircleMarkers(
    data = traffic,
    lng = ~lon,
    lat = ~lat,
    radius = 3,
    color = ~colorNumeric("RdYlBu", avg_volume)(avg_volume),  #average volume scale by color
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Street: ", street, "</b><br>",
      "Total Volume: ", total_volume, "<br>",
      "Average Volume: ", avg_volume, "<br>"), 
    group = "traffic_volume") %>%
  addLayersControl(
    overlayGroups = c("AED_locations" , "traffic_volume"),
    options = layersControlOptions(collapsed = FALSE))  
```